---
layout: post
title: Transparent Random Image Rotation
date: 
type: post
parent_id: '0'
published: false
password: ''
status: draft
categories: []
tags:
- Uncategorized
meta:
  _edit_last: '1'
author:
  login: Philihp
  email: philihp@gmail.com
  display_name: Philihp
  first_name: ''
  last_name: ''
---
<p>Thi</p>
<p>The following image displayed is a random image from the set. There should be no bias toward any image (assuming that any set of MD5 hashes will be of uniform distribution). It is based on the IP of the viewer and the time of day. It also updates hourly without the use of a cronjob, making this portable to hosts that don't want you running scripts.</p>
<p><img src="{{ site.baseurl }}/assets/hourly_random.jpg" /></p>
<h3>How I Did It</h3>
<h2>Redirect an Image Request to a PHP Script using mod_rewrite</h2>
<p>I have a directory called <a href="http://www.philihp.com/images/dump/">~/public_html/images/dump/</a>, and in it a null file called hourly_random. When you look at the contents of the directory, you can see it, but clicking on the image does not request that null image. Instead it is intercepted by mod_rewrite as configured by a hidden file <code>.htaccess</code> in that path (files beginning with a period in unix are hidden).</p>
<pre><code>RewriteEngine on
RewriteRule ^hourly_random.jpg$ /some/other/path/hourly_random.php [L]</code></pre>
<p>This says "Turn the RewriteEngine on (it is off by default); then check requests to this directory. If they match the pattern of "hourly_random.jpg" (^ means start of string, $ means end of string), then forward the request to hourly_random.php, and treat this as the last rule (<code>[L]</code>)stop looking for more rewrite rules.</p>
<h2>Query MySQL Table for Random Record</h2>
<p>Normally when you want to query a MySQL table for a random row, you would do something like this, saying "give me a random number for every record, and sort by them":</p>
<pre><code>SELECT imagename FROM images ORDER BY rand() LIMIT 1</code></pre>
<p>Since output from <a href="http://en.wikipedia.org/wiki/MD5">md5</a> is <a href="http://en.wikipedia.org/wiki/Deterministic_system_(mathematics)">deterministically</a> yet the output is unpredictably random, ordering by it gives us a random order that is the same every time.</p>
<pre><code>SELECT imagename FROM images ORDER BY md5(imagename) LIMIT 1</code></pre>
<p>I want a different order every hour, though. So doing this makes sure md5() gets an input that is the same within the hour, but different every hour. The dateformat string says take the current time (now()), and format it as a string with Year-Month-Day-Hour.</p>
<pre><code>SELECT imagename FROM images ORDER BY md5(concat(imagename,date_format(now(),'%Y%m%d%H'))) LIMIT 1</code></pre>
<p>Finally, to add the last bit of fun, have the PHP script send in the IP of the requester, so the md5 hash sort order will be different for every IP (person) who looks at it.</p>
<pre><code>SELECT imagename FROM images ORDER BY md5(concat(imagename,{$_SERVER[REMOTE_ADDR]},date_format(now(),'%Y%m%d%H'))) LIMIT 1</code></pre>
<h3>Make sure the image is cached</h3>
<p>The script should work now, but I put in one last optimization to tell browsers to cache the image for the remainder of an hour to save bandwidth. These headers are things Apache would normally put in automatically for static files (and our random image should LOOK like a static file to the browser in almost every way); however as the output of a PHP script, they aren't things PHP can automagically put in without extensive code that would normally slow down dynamic pages. So it must be done manually.</p>
<p><code>header('Etag: '.md5(filename));</code></p>
<p>Send an <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html#sec14.19">Etag</a>, which some browsers use as a way to determine if two files in cache are the same file. The contents of the Etag can be anything really, but hashing the filename cloaks the filename somewhat, and assuming you don't ever care to change the image without changing the filename, it is good enough. If you're paranoid, add some <a href="http://en.wikipedia.org/wiki/Salt_(cryptography)">salt</a>. Also, do this in the query above, if you really want, it doesn't add much processing overhead but protects you against <a href="http://en.wikipedia.org/wiki/Rainbow_table">rainbow table</a> attacks.</p>
<p><code>header('Last-Modified: '.gmdate('D, j M Y H').':00:00 GMT');</code></p>
<p>Send the Last-Modified header, which does the obvious. Tell the browser that the image last changed at the top of the current hour. This </p>
<p><code>header('Expires: '.gmdate('D, j M Y H',gmmktime()+60*60).':00:00 GMT');</code></p>
